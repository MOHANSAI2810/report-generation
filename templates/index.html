<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Expense Report</h1>
<!-- Dropdown form -->
<div class="form-container">
    <form method="POST" action="/">
        <label for="user_id">Select User:</label>
        <select name="user_id" id="user_id">
            {% for user_id in user_ids %}
            <option value="{{ user_id }}" {% if user_id==selected_user_id %}selected{% endif %}>
                User {{ user_id }}
            </option>
            {% endfor %}
        </select>
        <button type="submit">Fetch Records</button>
    </form>
</div>

<!-- Report Section -->
{% if expenses %}
<div class="report-section">
    <!-- Expense Table -->
    <h2>Expense Report for User {{ selected_user_id }}</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Category</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            {% for expense in expenses %}
            <tr>
                <td>{{ expense.expense_id }}</td>
                <td>{{ expense.category }}</td>
                <td>{{ expense.amount }}</td>
                <td>{{ expense.date }}</td>
                <td>{{ expense.description }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pie Chart -->
    <h2>Expense Distribution</h2>
    <canvas id="expensePieChart"></canvas>
</div>
<div class="container">
    <!-- Other content (e.g., table and chart) -->

    <!-- Export Buttons -->
    <div class="export-buttons" style="text-align: center; margin-top: 20px;">
        <a href="/download/csv?user_id={{ selected_user_id }}" class="export-btn">Download CSV</a>
        <a href="/download/excel?user_id={{ selected_user_id }}" class="export-btn">Download Excel</a>
        <a href="/download/pdf?user_id={{ selected_user_id }}" class="export-btn">Download PDF</a>
    </div>
</div>
{% endif %}

    <script>
        // Get category totals from the backend
        const categoryTotals = {{ category_totals | tojson }};

        // Prepare data for Chart.js
        const labels = Object.keys(categoryTotals);
        const data = Object.values(categoryTotals);

        // Generate the pie chart
        const ctx = document.getElementById('expensePieChart').getContext('2d');
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Expense Distribution',
                    data: data,
                    backgroundColor: [
                        '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'
                    ],
                    borderColor: '#ffffff',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function (tooltipItem) {
                                const category = labels[tooltipItem.dataIndex];
                                const amount = data[tooltipItem.dataIndex];
                                return `${category}: â‚¹${amount.toFixed(2)}`;
                            }
                        }
                    }
                }
            }
        });
    </script>
</body>

</html>